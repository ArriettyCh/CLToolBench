# 开发指南

## 项目架构

- `annotated_data/`：评测任务所需的数据和相关文件。
- `baseline/`：包含核心 MCP Copilot Agent 的实现代码。
  - `mcp_copilot/`：MCP Copilot Agent 的核心逻辑，包括工具路由、连接管理和服务器实现。
- `evaluator/`：包含用于评估 Agent 性能的脚本和工具（LiveMCPEval）。
- `tools/`：包含工具的定义、数据和管理脚本（LiveMCPTool）。
  - `LiveMCPTool/`：存放所有工具的原始配置文件，如 `all_config.json`。
- `utils/`：存放项目通用的辅助函数和脚本，例如用于连接和验证 MCP 服务器的脚本。

## LiveMCPBench 工作流

当前版本的 Agent 围绕一个完全静态的工具链构建，其工作流程如下：

1. **工具发现与验证**
    - **触发**：开发者手动运行 `tools/scripts/tool_check.sh` 脚本。
    - **执行**：该脚本调用 `utils/connect_mcp_server.py`。
    - **过程**：此 Python 脚本会读取 `tools/LiveMCPTool/all_config.json` 中的原始服务器配置列表。它会尝试连接每一个服务器，验证其可用性，并获取其提供的工具列表。
    - **产出**：生成一个名为 `tools/test/tools.json` 的静态文件。该文件包含了所有通过验证的、可用的工具及其详细信息，是整个工具链的“事实来源”。

2.  **工具信息处理与索引**
    - **触发**：Agent 服务启动时（通过 `baseline/mcp_copilot/server.py`）。
    - **执行**：`server.py` 会首先调用 `baseline/mcp_copilot/arg_generation.py` 中的 `run_generation()` 函数。
    - **过程**：`arg_generation.py` 脚本读取上一步生成的 `tools/test/tools.json` 文件。对于文件中的每一个工具，它会利用大语言模型（LLM）生成一个更自然的“摘要”（Summary），并使用嵌入模型（Embedding Model）为工具的描述和摘要创建向量嵌入。
    - **产出**：生成一个名为 `baseline/mcp_copilot/config/mcp_arg_... .json` 的文件（文件名取决于所用的模型）。这个文件包含了 Agent 进行工具匹配所需的所有预处理信息，包括工具描述、摘要和对应的向量嵌入。

3. **工具加载与路由**
   - **触发**：Agent 服务启动过程中，在 `server.py` 中初始化 `baseline/mcp_copilot/router.py` 内的 `Router` 类。
   - **执行**：`Router` 类是 Agent 的核心大脑。
   - **过程**
     - `Router` 初始化时，会创建一个 `ToolMatcher` 实例。
     - `ToolMatcher` 会加载上一步生成的 `mcp_arg_... .json` 文件，将其中包含的工具信息和向量嵌入加载到内存中，用于后续的语义匹配。
     - 同时，`Router` 也会加载一个“干净”的服务器配置文件 `baseline/mcp_copilot/config/clean_config.json`，该文件只包含连接服务器所需的基本信息（如启动命令或 URL），用于在需要时建立实际连接。

4. **工具执行**
   - **触发**：当 Agent 决定调用某个工具时。
   - **执行**：Agent 的 `route` 工具会使用 `ToolMatcher` 来根据用户查询找到最匹配的工具。确定目标工具后，`execute-tool` 工具会被调用。
   - **过程**：`Router` 的 `call_tool` 方法会根据工具名找到对应的服务器名，然后使用 `clean_config.json` 中的配置信息，通过 `MCPConnection` 类与该服务器建立一个临时的、实时的连接，并执行工具调用。

在当前架构下，所有工具必须在 Agent 启动前被完全定义、验证和索引，运行时的变动无效