# 开发计划

## 已实现：无

## 当前任务：支持工具的动态增删

### 1. 重构 `arg_generation.py` 以支持复用

**目标**：将批量处理工具信息的逻辑分解为可处理单个工具的、可复用的函数。

**文件**：`baseline/mcp_copilot/arg_generation.py`

-   **指南 1**：将 `McpArgGenerator` 类中的核心逻辑（如 `_get_embedding`, `_generate_summary`, `_format_tool_parameters`）提取成独立的、可复用的 `async` 函数。
-   **指南 2**：创建一个新的核心函数 `process_single_server_dynamically`。此函数接收单个服务器的已验证信息，并调用上述独立的辅助函数来完成摘要生成、嵌入创建和数据格式化的完整流程。它将作为 `Router` 中 `add_tool` 方法的主要数据处理单元。
-   **指南 3 & 4**：调整原有的 `generate` 和 `run_generation` 方法。它们现在可以调用新的 `process_single_server_dynamically` 函数来处理批量任务，但其在项目启动时的调用（见 `server.py` 的修改）应被重新评估或移除。

### 2. 改造 `Router` 类以实现动态管理

**目标**：修改 `Router` 类，使其成为动态工具集的“大脑”，负责在内存中维护和管理所有工具。

**文件**：`baseline/mcp_copilot/router.py`

-   **指南 1 & 2**：修改 `__init__` 方法。不再完全依赖静态配置文件，而是初始化一个空的、内存中的 `self.servers` 字典来存储服务器配置。可以保留从 `clean_config.json` 加载初始工具集的逻辑，但核心是为动态增删做准备。
-   **指南 3 & 4**：移除对 `mcp_arg_...json` 静态数据文件的直接依赖。在 `__init__` 中，`ToolMatcher` 应通过 `self.matcher.load_data([])` 加载一个空的数据结构，等待运行时动态填充。
-   **指南 5**：实现 `add_tool` 方法。这是动态化的关键。
    -   它接收新服务器的配置和描述。
    -   **步骤 1**：（需要实现）调用一个函数（可基于 `utils/connect_mcp_server.py` 的逻辑重构）来连接并验证新服务器，获取其工具列表。
    -   **步骤 2**：（需要实现）调用在 `arg_generation.py` 中重构好的 `process_single_server_dynamically` 函数，处理上一步获取的工具信息，生成摘要和嵌入。
    -   **步骤 3**：（需要实现）将新的服务器配置存入 `self.servers`，并将处理好的工具数据添加到 `ToolMatcher` 中（**注意**: 这需要在 `ToolMatcher` 类中额外实现一个如 `add_server_info` 的方法）。
-   **指南 6**：实现 `remove_tool` 方法。
    -   它接收要移除的服务器名称。
    -   **步骤 1**：（需要实现）从 `self.servers` 字典中删除对应的服务器配置。
    -   **步骤 2**：（需要实现）从 `ToolMatcher` 中移除该服务器的所有相关数据（**注意**: 这需要在 `ToolMatcher` 类中额外实现一个如 `remove_server_info` 的方法）。

### 3. 在 `server.py` 中暴露动态接口

**目标**：创建新的 Agent 工具，让 Agent 能够通过调用自己的能力来管理其工具集。

**文件**：`baseline/mcp_copilot/server.py`

-   **指南 1**：在 `serve` 函数的开头，注释掉或移除对 `asyncio.run(run_generation())` 的调用。因为工具管理已变为动态，不再需要在启动时进行静态索引。
-   **指南 2**：创建一个名为 `add_new_tool` 的新 Agent 工具。
    -   该工具接收 `server_name`, `server_config` (JSON 字符串) 和 `server_description` 作为参数。
    -   其实现会调用 `Router` 实例上的 `add_tool` 方法，将参数传递过去，从而完成新工具的动态添加。
-   **指南 3**：创建一个名为 `remove_existing_tool` 的新 Agent 工具。
    -   该工具接收 `server_name` 作为参数。
    -   其实现会调用 `Router` 实例上的 `remove_tool` 方法，完成工具的动态移除。